name: Update Changelog

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/CHANGELOG.md'
      - '.github/workflows/changelog.yml'

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    # Skip if commit message contains [skip changelog] or is from this workflow
    if: |
      !contains(github.event.head_commit.message, '[skip changelog]') &&
      !contains(github.event.head_commit.message, 'chore(changelog)')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get commit information
        id: commit_info
        run: |
          # Get the commit message and type
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
          COMMIT_DATE=$(date +%Y-%m-%d)
          AUTHOR="${{ github.event.head_commit.author.name }}"

          # Extract commit type from conventional commit format
          if [[ "$COMMIT_MSG" =~ ^feat(\(.+\))?:\ (.+) ]]; then
            TYPE="Added"
            DESC="${BASH_REMATCH[2]}"
          elif [[ "$COMMIT_MSG" =~ ^fix(\(.+\))?:\ (.+) ]]; then
            TYPE="Fixed"
            DESC="${BASH_REMATCH[2]}"
          elif [[ "$COMMIT_MSG" =~ ^refactor(\(.+\))?:\ (.+) ]]; then
            TYPE="Changed"
            DESC="${BASH_REMATCH[2]}"
          elif [[ "$COMMIT_MSG" =~ ^perf(\(.+\))?:\ (.+) ]]; then
            TYPE="Changed"
            DESC="[Performance] ${BASH_REMATCH[2]}"
          elif [[ "$COMMIT_MSG" =~ ^style(\(.+\))?:\ (.+) ]]; then
            TYPE="Changed"
            DESC="[Style] ${BASH_REMATCH[2]}"
          elif [[ "$COMMIT_MSG" =~ ^docs(\(.+\))?:\ (.+) ]]; then
            TYPE="Documentation"
            DESC="${BASH_REMATCH[2]}"
          elif [[ "$COMMIT_MSG" =~ ^build(\(.+\))?:\ (.+) ]]; then
            TYPE="Infrastructure"
            DESC="${BASH_REMATCH[2]}"
          elif [[ "$COMMIT_MSG" =~ ^ci(\(.+\))?:\ (.+) ]]; then
            TYPE="Infrastructure"
            DESC="[CI] ${BASH_REMATCH[2]}"
          elif [[ "$COMMIT_MSG" =~ ^test(\(.+\))?:\ (.+) ]]; then
            TYPE="Added"
            DESC="[Test] ${BASH_REMATCH[2]}"
          elif [[ "$COMMIT_MSG" =~ ^chore(\(.+\))?:\ (.+) ]]; then
            # Skip chore commits from changelog
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          else
            # Skip non-conventional commits
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract first line only
          DESC=$(echo "$DESC" | head -n1)

          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT
          echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        if: steps.commit_info.outputs.skip != 'true'
        run: |
          TYPE="${{ steps.commit_info.outputs.type }}"
          DESC="${{ steps.commit_info.outputs.desc }}"
          SHA="${{ steps.commit_info.outputs.sha }}"
          DATE="${{ steps.commit_info.outputs.date }}"

          CHANGELOG_FILE="docs/CHANGELOG.md"

          # Create backup
          cp "$CHANGELOG_FILE" "$CHANGELOG_FILE.bak"

          # Check if the section exists under [Unreleased]
          SECTION_HEADER="### ${TYPE}"

          # Read the file
          CONTENT=$(cat "$CHANGELOG_FILE")

          # Check if [Unreleased] section exists
          if ! grep -q "## \[Unreleased\]" "$CHANGELOG_FILE"; then
            # Add [Unreleased] section after the header
            sed -i '/^バージョニングは/a\\n## [Unreleased]' "$CHANGELOG_FILE"
          fi

          # Check if the type section exists under [Unreleased]
          # We need to add the entry under the correct section

          # Create the new entry
          NEW_ENTRY="- ${DESC} ([\`${SHA}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}))"

          # Use Python for more reliable text manipulation
          python3 << EOF
          import re

          with open("$CHANGELOG_FILE", "r", encoding="utf-8") as f:
              content = f.read()

          type_header = "### ${TYPE}"
          unreleased_pattern = r"(## \[Unreleased\].*?)(\n## \[|\Z)"

          match = re.search(unreleased_pattern, content, re.DOTALL)

          if match:
              unreleased_section = match.group(1)
              rest = match.group(2)

              # Check if type section exists in unreleased
              if type_header in unreleased_section:
                  # Add entry under existing section
                  section_pattern = rf"({re.escape(type_header)}.*?\n)"
                  unreleased_section = re.sub(
                      section_pattern,
                      rf"\1$NEW_ENTRY\n",
                      unreleased_section,
                      count=1
                  )
              else:
                  # Add new section after [Unreleased]
                  unreleased_section = unreleased_section.rstrip() + f"\n\n{type_header}\n$NEW_ENTRY\n"

              content = content[:match.start()] + unreleased_section + rest
          else:
              # Add new [Unreleased] section
              header_end = content.find("\n\n", content.find("Semantic Versioning"))
              if header_end == -1:
                  header_end = len(content)
              content = content[:header_end] + f"\n\n## [Unreleased]\n\n{type_header}\n$NEW_ENTRY\n" + content[header_end:]

          with open("$CHANGELOG_FILE", "w", encoding="utf-8") as f:
              f.write(content)
          EOF

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet docs/CHANGELOG.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/CHANGELOG.md
          git commit -m "chore(changelog): Update CHANGELOG.md [skip changelog]"
          git push
