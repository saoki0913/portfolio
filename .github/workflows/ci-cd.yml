name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã¨ãƒ“ãƒ«ãƒ‰
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8 (if available)
        run: |
          pip install flake8
          # stop the build if there are Python syntax errors or undefined names
          flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings
          flake8 src --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

      - name: Test backend startup
        run: |
          # ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
          export SUPABASE_URL=https://placeholder.supabase.co
          export SUPABASE_KEY=placeholder-key
          export BACKEND_CORS_ORIGINS='["http://localhost:3000"]'
          timeout 10s python -c "from src.main import app; print('Backend app loaded successfully')" || echo "Backend startup check completed"

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã¨ãƒ“ãƒ«ãƒ‰
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint with ESLint
        run: npm run lint
        continue-on-error: true

      - name: Type check with TypeScript
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Build frontend
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-key
        run: npm run build

  # ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  deploy-check:
    name: Deployment Verification
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Wait for Render deployment
        run: |
          echo "Waiting 60 seconds for Render auto-deploy to complete..."
          sleep 60

      - name: Check Render backend health
        run: |
          echo "Checking Render backend health endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://portfolio-backend-rf8v.onrender.com/)
          if [ "$response" -eq 200 ]; then
            echo "âœ… Render backend is healthy (HTTP $response)"
          else
            echo "âš ï¸ Render backend returned HTTP $response"
            exit 1
          fi

      - name: Wait for Vercel deployment
        run: |
          echo "Waiting 60 seconds for Vercel auto-deploy to complete..."
          sleep 60

      - name: Check Vercel frontend health
        run: |
          echo "Checking Vercel frontend..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://portfolio-saoki0913s-projects.vercel.app/)
          if [ "$response" -eq 200 ]; then
            echo "âœ… Vercel frontend is healthy (HTTP $response)"
          else
            echo "âš ï¸ Vercel frontend returned HTTP $response"
            exit 1
          fi

      - name: Summary
        run: |
          echo "================================"
          echo "ğŸ“Š Deployment Status Summary"
          echo "================================"
          echo "Backend (Render): https://portfolio-backend-rf8v.onrender.com/"
          echo "Frontend (Vercel): https://portfolio-saoki0913s-projects.vercel.app/"
          echo "================================"
