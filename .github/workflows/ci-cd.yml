name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  # „Éá„Éó„É≠„Ç§ÂÖàURL
  RENDER_BACKEND_URL: https://portfolio-backend-rf8v.onrender.com
  VERCEL_FRONTEND_URL: https://portfolio-frontend-saoki0913s-projects.vercel.app

jobs:
  # ============================================
  # „Çπ„ÉÜ„Éº„Ç∏1: „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅÆÊ§úË®º
  # ============================================
  backend-test:
    name: üêç Backend Test & Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8
        run: |
          pip install flake8
          # Ëá¥ÂëΩÁöÑ„Å™„Ç®„É©„Éº„ÅÆ„Åø„ÉÅ„Çß„ÉÉ„ÇØÔºà„Åì„Çå„ÅåÂ§±Êïó„Åô„Çã„Å®„Éá„Éó„É≠„Ç§„ÇÇÂ§±Êïó„Åô„ÇãÔºâ
          flake8 app --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Verify FastAPI app can be imported
        run: |
          export SUPABASE_URL=https://placeholder.supabase.co
          export SUPABASE_KEY=placeholder-key
          export BACKEND_CORS_ORIGINS='["http://localhost:3000"]'
          python -c "
          from app.main import app
          print('‚úÖ FastAPI app imported successfully')

          # „É´„Éº„Éà„ÅÆÁ¢∫Ë™ç
          routes = [route.path for route in app.routes]
          print(f'‚úÖ Routes found: {len(routes)}')
          for route in routes[:10]:
              print(f'   - {route}')
          "

      - name: Test API endpoints locally
        run: |
          export SUPABASE_URL=https://placeholder.supabase.co
          export SUPABASE_KEY=placeholder-key
          export BACKEND_CORS_ORIGINS='["http://localhost:3000"]'

          # „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Åß„Çµ„Éº„Éê„ÉºËµ∑Âãï
          python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          SERVER_PID=$!
          
          # „Çµ„Éº„Éê„ÉºËµ∑ÂãïÂæÖÊ©ü
          echo "Waiting for server to start..."
          sleep 5
          
          # „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/)
          if [ "$response" -eq 200 ]; then
            echo "‚úÖ Local backend health check passed (HTTP $response)"
          else
            echo "‚ùå Local backend health check failed (HTTP $response)"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          
          # OpenAPI schemaÁ¢∫Ë™çÔºàFastAPI„ÅåÊ≠£„Åó„ÅèÂãï‰Ωú„Åó„Å¶„ÅÑ„Çã„ÅãÔºâ
          schema_response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/openapi.json)
          if [ "$schema_response" -eq 200 ]; then
            echo "‚úÖ OpenAPI schema available"
          else
            echo "‚ö†Ô∏è OpenAPI schema not available (HTTP $schema_response)"
          fi
          
          # „Çµ„Éº„Éê„ÉºÂÅúÊ≠¢
          kill $SERVER_PID 2>/dev/null || true

  # ============================================
  # „Çπ„ÉÜ„Éº„Ç∏2: „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„ÅÆÊ§úË®º
  # ============================================
  frontend-test:
    name: ‚öõÔ∏è Frontend Test & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint with ESLint
        run: npm run lint

      - name: Type check with TypeScript
        run: npx tsc --noEmit

      - name: Build frontend (Production)
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_API_URL: ${{ env.RENDER_BACKEND_URL }}
        run: |
          # Áí∞Â¢ÉÂ§âÊï∞„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Çí‰ΩøÁî®
          export NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:-https://placeholder.supabase.co}
          export NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:-placeholder-key}
          npm run build
          echo "‚úÖ Frontend build completed successfully"

      - name: Verify build output
        run: |
          if [ -d ".next" ]; then
            echo "‚úÖ .next directory exists"
            du -sh .next
          else
            echo "‚ùå .next directory not found"
            exit 1
          fi

  # ============================================
  # „Çπ„ÉÜ„Éº„Ç∏3: „Éá„Éó„É≠„Ç§Âæå„ÅÆÊ§úË®ºÔºàmain„Éñ„É©„É≥„ÉÅ„ÅÆ„ÅøÔºâ
  # ============================================
  deploy-verification:
    name: üöÄ Deployment Verification
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Initial wait for deployments to trigger
        run: |
          echo "‚è≥ Waiting 30 seconds for deployment triggers..."
          sleep 30

      # ------------------------------------------
      # Render „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅÆÊ§úË®º
      # ------------------------------------------
      - name: üîÑ Poll Render backend until healthy
        id: render-check
        run: |
          echo "Checking Render backend: ${{ env.RENDER_BACKEND_URL }}"
          
          MAX_ATTEMPTS=20
          WAIT_SECONDS=30
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS..."
            
            response=$(curl -s -o /tmp/response.txt -w "%{http_code}" "${{ env.RENDER_BACKEND_URL }}/")
            
            if [ "$response" -eq 200 ]; then
              echo "‚úÖ Render backend is healthy (HTTP $response)"
              cat /tmp/response.txt
              echo ""
              echo "RENDER_STATUS=success" >> $GITHUB_OUTPUT
              break
            else
              echo "‚è≥ Backend returned HTTP $response, waiting ${WAIT_SECONDS}s..."
              if [ "$i" -eq "$MAX_ATTEMPTS" ]; then
                echo "‚ùå Render backend failed after $MAX_ATTEMPTS attempts"
                echo "RENDER_STATUS=failed" >> $GITHUB_OUTPUT
                exit 1
              fi
              sleep $WAIT_SECONDS
            fi
          done

      - name: üîç Verify Render API endpoints
        run: |
          echo "Testing API endpoints..."
          
          # /docs „Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÔºàSwagger UIÔºâ
          docs_response=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.RENDER_BACKEND_URL }}/docs")
          if [ "$docs_response" -eq 200 ]; then
            echo "‚úÖ /docs endpoint available (HTTP $docs_response)"
          else
            echo "‚ö†Ô∏è /docs endpoint returned HTTP $docs_response"
          fi
          
          # /openapi.json „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
          openapi_response=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.RENDER_BACKEND_URL }}/openapi.json")
          if [ "$openapi_response" -eq 200 ]; then
            echo "‚úÖ /openapi.json endpoint available (HTTP $openapi_response)"
          else
            echo "‚ö†Ô∏è /openapi.json endpoint returned HTTP $openapi_response"
          fi

      # ------------------------------------------
      # Vercel „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„ÅÆÊ§úË®º
      # ------------------------------------------
      - name: üîÑ Poll Vercel frontend until healthy
        id: vercel-check
        run: |
          echo "Checking Vercel frontend: ${{ env.VERCEL_FRONTEND_URL }}"
          
          MAX_ATTEMPTS=15
          WAIT_SECONDS=20
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS..."
            
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.VERCEL_FRONTEND_URL }}/")
            
            if [ "$response" -eq 200 ]; then
              echo "‚úÖ Vercel frontend is healthy (HTTP $response)"
              echo "VERCEL_STATUS=success" >> $GITHUB_OUTPUT
              break
            else
              echo "‚è≥ Frontend returned HTTP $response, waiting ${WAIT_SECONDS}s..."
              if [ "$i" -eq "$MAX_ATTEMPTS" ]; then
                echo "‚ùå Vercel frontend failed after $MAX_ATTEMPTS attempts"
                echo "VERCEL_STATUS=failed" >> $GITHUB_OUTPUT
                exit 1
              fi
              sleep $WAIT_SECONDS
            fi
          done

      - name: üîç Verify Vercel pages
        run: |
          echo "Testing frontend pages..."
          
          # „É°„Ç§„É≥„Éö„Éº„Ç∏„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑÁ¢∫Ë™ç
          content=$(curl -s "${{ env.VERCEL_FRONTEND_URL }}/")
          if echo "$content" | grep -q "</html>"; then
            echo "‚úÖ Main page returns valid HTML"
          else
            echo "‚ö†Ô∏è Main page might not return valid HTML"
          fi

      # ------------------------------------------
      # Áµ±Âêà„ÉÜ„Çπ„Éà: „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ ‚Üí „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ
      # ------------------------------------------
      - name: üîó Verify Frontend-Backend Integration
        run: |
          echo "Testing CORS and connectivity..."
          
          # „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å∏„ÅÆCORS„Éó„É™„Éï„É©„Ç§„Éà„É™„ÇØ„Ç®„Çπ„Éà„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
          cors_response=$(curl -s -o /dev/null -w "%{http_code}" \
            -X OPTIONS \
            -H "Origin: ${{ env.VERCEL_FRONTEND_URL }}" \
            -H "Access-Control-Request-Method: GET" \
            "${{ env.RENDER_BACKEND_URL }}/")
          
          if [ "$cors_response" -eq 200 ] || [ "$cors_response" -eq 204 ]; then
            echo "‚úÖ CORS preflight successful (HTTP $cors_response)"
          else
            echo "‚ö†Ô∏è CORS preflight returned HTTP $cors_response (may still work)"
          fi

      # ------------------------------------------
      # ÊúÄÁµÇ„Çµ„Éû„É™„Éº
      # ------------------------------------------
      - name: üìä Deployment Summary
        run: |
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë           üéâ DEPLOYMENT VERIFICATION COMPLETE üéâ           ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë                                                            ‚ïë"
          echo "‚ïë  üì¶ Backend (Render):                                      ‚ïë"
          echo "‚ïë     ${{ env.RENDER_BACKEND_URL }}"
          echo "‚ïë     Status: ‚úÖ Healthy                                     ‚ïë"
          echo "‚ïë                                                            ‚ïë"
          echo "‚ïë  üåê Frontend (Vercel):                                     ‚ïë"
          echo "‚ïë     ${{ env.VERCEL_FRONTEND_URL }}"
          echo "‚ïë     Status: ‚úÖ Healthy                                     ‚ïë"
          echo "‚ïë                                                            ‚ïë"
          echo "‚ïë  üìö API Docs:                                              ‚ïë"
          echo "‚ïë     ${{ env.RENDER_BACKEND_URL }}/docs"
          echo "‚ïë                                                            ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""

  # ============================================
  # „Çπ„ÉÜ„Éº„Ç∏4: „Éá„Éó„É≠„Ç§Â§±ÊïóÊôÇ„ÅÆÈÄöÁü•Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
  # ============================================
  notify-failure:
    name: üö® Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy-verification]
    if: failure()

    steps:
      - name: Create failure summary
        run: |
          echo "## ‚ùå Deployment Verification Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment verification has failed. Please check:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Render Dashboard**: Check if the backend deployment succeeded" >> $GITHUB_STEP_SUMMARY
          echo "2. **Vercel Dashboard**: Check if the frontend deployment succeeded" >> $GITHUB_STEP_SUMMARY
          echo "3. **Environment Variables**: Ensure all required variables are set" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Render Dashboard](https://dashboard.render.com/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Vercel Dashboard](https://vercel.com/)" >> $GITHUB_STEP_SUMMARY